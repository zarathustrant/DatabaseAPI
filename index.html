<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map with GeoJSON Features, Device Location, and Editable Properties</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map {
            width: 100%;
            height: 600px;
        }
        body {
            font-family: Arial, sans-serif;
        }
        .layer-info {
            margin-top: 20px;
        }
        input, select {
            width: 100%;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>Map with Editable GeoJSON Features and Device Location</h1>
    <div id="map"></div> <!-- Leaflet map will be rendered here -->
    
    <div id="layer-list" class="layer-info"></div> <!-- List of features' details -->

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const CACHE_EXPIRATION = 3600000; // 1 hour (in milliseconds)
        const CACHE_KEY = 'geojson_features';
        const API_URL = 'https://databaseapi-t454.onrender.com/features'; // Replace with your API endpoint

        // Initialize the Leaflet map with tap enabled
        var map = L.map('map', {
            center: [10.5264, 7.4386], // Initial coordinates
            zoom: 14,
            tap: true, // Enables tap interaction for touch devices
            tapTolerance: 10 // Optional, adjusts tolerance for touch precision
        });

        // Add a tile layer (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Function to check if the data in localStorage is valid
        function isCacheValid() {
            const cachedData = localStorage.getItem(CACHE_KEY);
            const cacheTime = localStorage.getItem(CACHE_KEY + '_timestamp');
            if (!cachedData || !cacheTime) return false;
            return (new Date().getTime() - cacheTime) < CACHE_EXPIRATION;
        }

        // Function to load GeoJSON data and display it on the map
        function loadGeoJsonData(data) {
            const layerList = document.getElementById('layer-list');
            layerList.innerHTML = ''; // Clear existing content

            // Loop through each feature in the JSON data and plot on the map
            data.forEach((layer, index) => {
                // Extract coordinates and create a marker
                const coordinates = layer.geometry.coordinates;
                const marker = L.marker([coordinates[1], coordinates[0]]).addTo(map);

                // Dynamically generate an editable form popup content
                let popupContent = `<form id="edit-form-${index}">`;
                for (let property in layer.properties) {
                    popupContent += `<label for="${property}"><b>${property}</b>:</label><br>`;
                    popupContent += `<input type="text" id="${property}" name="${property}" value="${layer.properties[property] || ''}" /><br>`;
                }
                popupContent += `<button type="submit">Save</button></form>`;

                // Add a click event to the marker to show the popup
                marker.bindPopup(popupContent);

                // Handle form submission to update the properties
                marker.on('popupopen', function () {
                    const form = document.getElementById(`edit-form-${index}`);
                    form.addEventListener('submit', function (event) {
                        event.preventDefault();

                        // Collect updated data from the form
                        const updatedProperties = {};
                        for (let property in layer.properties) {
                            updatedProperties[property] = form.elements[property].value;
                        }

                        // Update the feature properties in the database via the API
                        updateFeatureInDatabase(layer._id, updatedProperties);

                        // Update the marker's popup content with the new values
                        marker.bindPopup(createPopupContent(updatedProperties, coordinates)).openPopup();
                    });
                });

                // Create a div for each feature to show details below the map
                const featureDiv = document.createElement('div');
                featureDiv.classList.add('feature');
                
                // Display feature properties in the list below the map
                let featureDetails = `<h3>Layer ${index + 1}</h3>`;
                featureDetails += `<p><b>_id:</b> ${layer._id}</p>`;
                featureDetails += `<p><b>Coordinates:</b> [${coordinates[1]}, ${coordinates[0]}]</p>`;
                for (let property in layer.properties) {
                    featureDetails += `<p><b>${property}:</b> ${layer.properties[property] || "N/A"}</p>`;
                }
                
                featureDiv.innerHTML = featureDetails;

                // Append to the layer list
                layerList.appendChild(featureDiv);
            });
        }

        // Function to send the updated feature to the API
        function updateFeatureInDatabase(id, updatedProperties) {
            fetch(`${API_URL}/${id}`, {
                method: 'PUT', // Change to POST if needed based on your API design
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ properties: updatedProperties })
            })
            .then(response => response.json())
            .then(data => {
                alert('Feature updated successfully');
            })
            .catch(error => {
                console.error('Error updating feature:', error);
            });
        }

        // Function to fetch data from the API and cache it
        function fetchDataAndCache() {
            fetch(API_URL)
                .then(response => response.json())
                .then(data => {
                    localStorage.setItem(CACHE_KEY, JSON.stringify(data)); // Cache the data
                    localStorage.setItem(CACHE_KEY + '_timestamp', new Date().getTime()); // Cache the timestamp
                    loadGeoJsonData(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    const layerList = document.getElementById('layer-list');
                    layerList.innerHTML = `<p class="error">Error fetching data: ${error.message}</p>`;
                });
        }

        // Main logic: Check if the data is already cached and valid
        if (isCacheValid()) {
            const cachedData = JSON.parse(localStorage.getItem(CACHE_KEY));
            loadGeoJsonData(cachedData); // Load data from cache
        } else {
            fetchDataAndCache(); // Fetch data from API and cache it
        }

        // Function to add the user's current location to the map
        function addUserLocation() {
            map.locate({ setView: true, maxZoom: 16 }); // Automatically pan to user's location

            // Event listener when location is found
            map.on('locationfound', function (e) {
                var radius = e.accuracy / 2;

                // Add marker for user's location
                L.marker(e.latlng).addTo(map)
                    .bindPopup("You are within " + radius + " meters from this point").openPopup();

                // Add a circle to indicate the accuracy of the location
                L.circle(e.latlng, radius).addTo(map);
            });

            // Event listener when location is not found
            map.on('locationerror', function () {
                alert("Unable to find your location.");
            });
        }

        // Call the function to add the user's location to the map
        addUserLocation();

    </script>
</body>
</html>
