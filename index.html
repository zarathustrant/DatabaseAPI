<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>Field Worker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        /* General Dark Theme with Lemon Accents */
        body {
            background-color: #1c1c1e;
            color: #f4f4f4;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        h1 {
            color: #f4f4f4;
            text-align: center;
            padding: 15px 0;
            font-size: 1.5em; /* Smaller text for mobile */
        }

        #map {
            width: 100%;
            height: 70vh; /* 70% of the viewport height for the map */
            margin-bottom: 15px;
            border: 2px solid #f4f4f4;
        }

        input, select, button {
            width: 100%;
            margin-bottom: 10px;
            padding: 15px; /* Larger padding for easier touch interaction */
            background-color: #333;
            color: #f4f4f4;
            border: 1px solid #f4f4f4;
            border-radius: 5px;
            font-size: 1em; /* Increase font size for mobile readability */
        }

        button {
            background-color: #f4f4f4;
            color: #1c1c1e;
            font-weight: bold;
            cursor: pointer;
        }

        button:hover {
            background-color: #e5e500;
            color: #1c1c1e;
        }

        label {
            color: #e5e500; /* Lemon accent for form labels */
            font-size: 0.9em; /* Slightly smaller label size */
        }

        .leaflet-container {
            background-color: #1c1c1e; /* Dark map background */
        }

        .leaflet-popup-content-wrapper {
            background-color: #2c2c2e;
            color: #f4f4f4;
        }

        .leaflet-popup-tip {
            background-color: #2c2c2e;
        }

        .leaflet-popup-content button {
            background-color: #e5e500; /* Lemon accent for popup buttons */
            color: #1c1c1e;
            border: none;
            padding: 10px;
            font-size: 1em;
            border-radius: 5px;
        }

        .leaflet-popup-content button:hover {
            background-color: #d4d400;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.3em; /* Further reduce heading size on smaller screens */
            }

            input, select, button {
                font-size: 0.9em; /* Adjust font size for smaller screens */
                padding: 12px; /* Slightly smaller padding on small devices */
            }

            #map {
                height: 75vh; /* Use more screen height for the map on mobile */
            }
        }
    </style>
</head>
<body>
    <h1>Field Worker</h1>
    <div id="map"></div> <!-- Leaflet map will be rendered here -->

    <script>
        const CACHE_EXPIRATION = 3600000; // 1 hour (in milliseconds)
        const CACHE_KEY = 'geojson_features';
        const API_URL = 'https://databaseapi-t454.onrender.com/features'; // Updated API URL

        // Initialize the Leaflet map with Google Earth Hybrid as the base layer
        var map = L.map('map', {
            center: [10.5264, 7.4386], // Initial coordinates
            zoom: 14,
            tap: true, // Enables tap interaction for touch devices
            tapTolerance: 10 // Optional, adjusts tolerance for touch precision
        });

        // Google Earth Hybrid layer (Direct Tile URL approach)
        var googleSatHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            attribution: '&copy; <a href="https://www.google.com/earth/">Google Earth</a>',
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            maxZoom: 19
        }).addTo(map); // Add the layer to the map

        // Function to check if the data in localStorage is valid
        function isCacheValid() {
            const cachedData = localStorage.getItem(CACHE_KEY);
            const cacheTime = localStorage.getItem(CACHE_KEY + '_timestamp');
            if (!cachedData || !cacheTime) return false;
            return (new Date().getTime() - cacheTime) < CACHE_EXPIRATION;
        }

        // Function to load GeoJSON data and display it on the map
        function loadGeoJsonData(data) {
            // Loop through each feature in the JSON data and plot on the map
            data.forEach((layer, index) => {
                // Extract coordinates and create a marker
                const coordinates = layer.geometry.coordinates;
                const marker = L.marker([coordinates[1], coordinates[0]]).addTo(map);

                // Dynamically generate an editable form popup content
                let popupContent = `<form id="edit-form-${index}">`;
                for (let property in layer.properties) {
                    popupContent += `<label for="${property}"><b>${property}</b>:</label><br>`;
                    popupContent += `<input type="text" id="${property}" name="${property}" value="${layer.properties[property] || ''}" /><br>`;
                }
                popupContent += `<button type="submit">Save</button></form>`;

                // Add a click event to the marker to show the popup
                marker.bindPopup(popupContent);

                // Handle form submission to update the properties
                marker.on('popupopen', function () {
                    const form = document.getElementById(`edit-form-${index}`);
                    form.addEventListener('submit', function (event) {
                        event.preventDefault();

                        // Collect updated data from the form
                        const updatedProperties = {};
                        for (let property in layer.properties) {
                            updatedProperties[property] = form.elements[property].value;
                        }

                        // Update the feature properties in the database via the API
                        updateFeatureInDatabase(layer._id, updatedProperties);

                        // Update the marker's popup content with the new values
                        let updatedPopupContent = `<b>Coordinates:</b> [${coordinates[1]}, ${coordinates[0]}]<br>`;
                        for (let property in updatedProperties) {
                            updatedPopupContent += `<b>${property}:</b> ${updatedProperties[property]}<br>`;
                        }
                        marker.setPopupContent(updatedPopupContent);
                    });
                });
            });
        }

        // Function to send the updated feature to the API
        function updateFeatureInDatabase(id, updatedProperties) {
            fetch(`${API_URL}/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ properties: updatedProperties })
            })
            .then(response => response.json())
            .then(data => {
                alert('Feature updated successfully');
                localStorage.removeItem(CACHE_KEY); // Invalidate cache to reload updated data
            })
            .catch(error => {
                console.error('Error updating feature:', error);
            });
        }

        // Function to fetch data from the API and cache it
        function fetchDataAndCache() {
            fetch(API_URL)
                .then(response => response.json())
                .then(data => {
                    localStorage.setItem(CACHE_KEY, JSON.stringify(data)); // Cache the data
                    localStorage.setItem(CACHE_KEY + '_timestamp', new Date().getTime()); // Cache the timestamp
                    loadGeoJsonData(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }

        // Main logic: Check if the data is already cached and valid
        if (isCacheValid()) {
            const cachedData = JSON.parse(localStorage.getItem(CACHE_KEY));
            loadGeoJsonData(cachedData); // Load data from cache
        } else {
            fetchDataAndCache(); // Fetch data from API and cache it
        }

        // Function to add the user's current location to the map
        function addUserLocation() {
            map.locate({ setView: true, maxZoom: 16 }); // Automatically pan to user's location

            // Event listener when location is found
            map.on('locationfound', function (e) {
                var radius = e.accuracy / 2;

                // Add marker for user's location
                L.marker(e.latlng).addTo(map)
                    .bindPopup("You are within " + radius + " meters from this point").openPopup();

                // Add a circle to indicate the accuracy of the location
                L.circle(e.latlng, radius).addTo(map);
            });

            // Event listener when location is not found
            map.on('locationerror', function () {
                alert("Unable to find your location.");
            });
        }

        // Call the function to add the user's location to the map
        addUserLocation();

    </script>
</body>
</html>
