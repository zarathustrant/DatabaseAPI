<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>Field Worker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Leaflet Measure -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css" />
    <script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>
    <!-- Leaflet Draw -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <style>
        /* General Dark Theme with Lemon Accents */
        body, html {
            margin: 0;
            padding: 0;
            background-color: #1c1c1e;
            color: #f4f4f4;
            font-family: Arial, sans-serif;
            height: 100%;
        }

        h1 {
            color: #f4f4f4;
            text-align: center;
            padding: 15px 0;
            font-size: 1.5em;
        }

        #map {
            width: 100%;
            height: 100vh; /* Use full viewport height */
            margin: 0;
        }

        input, select, button {
            width: 100%;
            margin-bottom: 10px;
            padding: 15px;
            background-color: #333;
            color: #f4f4f4;
            border: 1px solid #f4f4f4;
            border-radius: 5px;
            font-size: 1em;
        }

        button {
            background-color: #f4f4f4;
            color: #1c1c1e;
            font-weight: bold;
            cursor: pointer;
        }

        button:hover {
            background-color: #e5e500;
            color: #1c1c1e;
        }

        label {
            color: #e5e500;
            font-size: 0.9em;
        }

        .leaflet-container {
            background-color: #1c1c1e;
        }

        .leaflet-popup-content-wrapper {
            background-color: #2c2c2e;
            color: #f4f4f4;
        }

        .leaflet-popup-tip {
            background-color: #2c2c2e;
        }

        .leaflet-popup-content button {
            background-color: #e5e500;
            color: #1c1c1e;
            border: none;
            padding: 10px;
            font-size: 1em;
            border-radius: 5px;
        }

        .leaflet-popup-content button:hover {
            background-color: #d4d400;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.3em;
            }

            input, select, button {
                font-size: 0.9em;
                padding: 12px;
            }

            #map {
                height: 100vh;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div> <!-- Leaflet map will be rendered here -->

    <script>
        const CACHE_EXPIRATION = 3600000; // 1 hour (in milliseconds)
        const CACHE_KEY = 'geojson_features';
        const API_URL = 'https://databaseapi-t454.onrender.com/features'; // Updated API URL



        // Dynamically adjust map height to account for browser toolbars
        function adjustMapHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
            document.getElementById('map').style.height = `${window.innerHeight}px`;
        }

        // Call the adjust function on load and resize
        window.addEventListener('load', adjustMapHeight);
        window.addEventListener('resize', adjustMapHeight);

        // Initialize the Leaflet map with Google Earth Hybrid as the base layer
        var map = L.map('map', {
            center: [10.5264, 7.4386], // Initial coordinates
            zoom: 14,
            tap: true, // Enables tap interaction for touch devices
            tapTolerance: 10
        });

        // Google Earth Hybrid layer (Direct Tile URL approach)
        var googleSatHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            attribution: '&copy; <a href="https://www.google.com/earth/">Google Earth</a>',
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            maxZoom: 19
        }).addTo(map); // Add the layer to the map

        // Function to check if the data in localStorage is valid
        function isCacheValid() {
            const cachedData = localStorage.getItem(CACHE_KEY);
            const cacheTime = localStorage.getItem(CACHE_KEY + '_timestamp');
            if (!cachedData || !cacheTime) return false;
            return (new Date().getTime() - cacheTime) < CACHE_EXPIRATION;
        }

        // Function to load GeoJSON data and display it on the map
        function loadGeoJsonData(data) {
            // Loop through each feature in the JSON data and plot on the map
            data.forEach((layer, index) => {
                const coordinates = layer.geometry.coordinates;
                const marker = L.marker([coordinates[1], coordinates[0]]).addTo(map);

                let popupContent = `<form id="edit-form-${index}">`;
                for (let property in layer.properties) {
                    popupContent += `<label for="${property}"><b>${property}</b>:</label><br>`;
                    popupContent += `<input type="text" id="${property}" name="${property}" value="${layer.properties[property] || ''}" /><br>`;
                }
                popupContent += `<button type="submit">Save</button></form>`;

                marker.bindPopup(popupContent);

                marker.on('popupopen', function () {
                    const form = document.getElementById(`edit-form-${index}`);
                    form.addEventListener('submit', function (event) {
                        event.preventDefault();

                        const updatedProperties = {};
                        for (let property in layer.properties) {
                            updatedProperties[property] = form.elements[property].value;
                        }

                        updateFeatureInDatabase(layer._id, updatedProperties);

                        let updatedPopupContent = `<b>Coordinates:</b> [${coordinates[1]}, ${coordinates[0]}]<br>`;
                        for (let property in updatedProperties) {
                            updatedPopupContent += `<b>${property}:</b> ${updatedProperties[property]}<br>`;
                        }
                        marker.setPopupContent(updatedPopupContent);
                    });
                });
            });
        }

        function updateFeatureInDatabase(id, updatedProperties) {
            fetch(`${API_URL}/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ properties: updatedProperties })
            })
            .then(response => response.json())
            .then(data => {
                alert('Feature updated successfully');
                localStorage.removeItem(CACHE_KEY); // Invalidate cache to reload updated data
            })
            .catch(error => {
                console.error('Error updating feature:', error);
            });
        }

        function fetchDataAndCache() {
            fetch(API_URL)
                .then(response => response.json())
                .then(data => {
                    localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                    localStorage.setItem(CACHE_KEY + '_timestamp', new Date().getTime());
                    loadGeoJsonData(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }

        if (isCacheValid()) {
            const cachedData = JSON.parse(localStorage.getItem(CACHE_KEY));
            loadGeoJsonData(cachedData);
        } else {
            fetchDataAndCache();
        }

        function addUserLocation() {
            map.locate({ setView: true, maxZoom: 16 });
            map.on('locationfound', function (e) {
                const radius = e.accuracy / 2;
                L.marker(e.latlng).addTo(map)
                    .bindPopup("You are within " + radius + " meters from this point").openPopup();
                L.circle(e.latlng, radius).addTo(map);
            });

            map.on('locationerror', function () {
                alert("Unable to find your location.");
            });
        }

        addUserLocation();

        // Initialize the Measure tool
        var measureControl = new L.Control.Measure({
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares',
            activeColor: '#e5e500',
            completedColor: '#e5e500'
        });
        measureControl.addTo(map);

        // Initialize the Draw tool
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        var drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems
            }
        });
        map.addControl(drawControl);

        // Handle Draw events
        map.on(L.Draw.Event.CREATED, function (event) {
            var layer = event.layer;
            drawnItems.addLayer(layer);
        });

        map.on(L.Draw.Event.EDITED, function (event) {
            var layers = event.layers;
            layers.eachLayer(function (layer) {
                console.log(layer);
            });
        });


    </script>

    <!-- Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/sw.js').then(function(registration) {
            console.log('Service Worker registered with scope: ', registration.scope);
          }, function(error) {
            console.log('Service Worker registration failed: ', error);
          });
        });
      }


    
    </script>
</body>
</html>
